

Consul是一个复杂的系统，有许多不同的部件。这里将从Consul工作的内在模型开始，来帮助使用者和开发人员。这篇文章将介绍系统架构。

> [!] 本文将介绍Consul内部的技术细节，对于实际操作和使用Consul的人不需要知道这些细节。这些细节记录在这里是为那些希望了解它们的人，小伙伴们不必再去探索源代码。

# 术语（Glossary）

在开始描述架构之前，我们先提供一个术语词汇表，以帮助理清将要讨论的内容：

- `Agent` - 是在Consul集群的每个成员之上长期运行的一个守护进程。它通过运行`consul agent`启动。Agent可以运行在客户端或者服务器模式下。所有的节点都必须运行一个Agent，除了客户端或者服务器节点，也有其它的Agent实例。所有的节点都可以运行DNS和HTTP接口，以及负责运行健康检查和保持服务同步。

- `Client` - 是转发所有`RPC`到`Server`节点的`Agent`。`Client`是相对无状态的。`Client`执行的唯一的后台活动是参与`LAN gossip pool`。这只有一个很小的资源开销，并且只消耗少量的网络带宽。

- `Server` - 是具备一组扩展职责的`Agent`，包括：参与`Raft法定人数`（`quorum`），维护集群状态，响应RPC请求，与其它数据中心交换`WAN Gossip`，以及转发请求到leader或者远程数据中心。

- `Datacenter`（`数据中心`） - 虽然数据中心的定义似乎是显而易见的，但必须考虑一些细微的细节。我们定义一个数据中心是一个私有的、低延迟，以及高带宽的网络环境。这排除了通信需要通过公共因特网进行的。

- `Consensus`(`一致性`) - 当在我们的文档中使用这个词时，一致既意味着在leader选举时达成一致，还代表在事务处理上达成一致。因为这些事务被应用到有限状态机，这里的一致性定义意味着状态机复制的一致性。

- `Gossip` - Consul构建于[Serf](https://www.serf.io/)之上，其提供了一个完整的`gossip protocol`支持，被用在多种用途。[Serf](https://www.serf.io/) 提供**成员管理**、**故障检测**和**事件广播**的功能。这些功能在 gossip文档 中有详细描述。这里只要知道 gossip 主要通过`UDP`进行**随机的点对点通信**就可以了。

- `LAN Gossip` - 指包含位于同一局域网或数据中心的所有节点的`LAN gossip pool`。

- `WAN Gossip` - 指仅包含Server节点的`WAN gossip pool`。这些Server位于不同的数据中心，通常通过因特网或广域网进行通信。

- `RPC` - 远程过程调用。这是一种允许客户端发送一个请求到服务端的`请求/响应机制`。



# 整体架构（10,000 foot view）

从整体来看 Consul 的架构，大概像一下这个：

![](../images/consul-arch-420ce04a.png)

让我们分开来看一下每一部分。首先，我们看到有两个数据中心，标记为“1”和“2”。Consul对多数据中心的支持是一流的，它预料这是一种常见的场景。

在每个数据中心，Client和Server是混合存在的。Server的数量一般是3-5个，这个数量应权衡`故障情况下的可用性`和`性能`之间的平衡，因为越多的机器加入一致性处理就越慢。然而，Client的数量是没有限制的，它们可以容易的扩展到成千上万个。

某个数据中心下的所有节点都参与同一个`Gossip`协议，这意味着对一个指定的数据中心会有一个包含所有节点的 `Gossip`池。`Gossip`提供了一些用途：
- 首先，不需要使用Server的地址配置客户端，发现是自动的；
- 其次，检测节点故障的工作没有被放置在Server上，而是分布式的，这让故障检测比简单的心跳方案更具伸缩性；
- 再者，当重要的事件发生时它可以作为消息层用来发送通知，比如leader选举发生时。

每个数据中心下的Server都是一个Raft点集的部分。这意味着他们一起工作来选举一个leader，选中的Server有一些扩展的职责。leader负责处理所有的查询和事务，事务还必须被复制到参与一致性协议的所有对等点。考虑到这个要求，当一个非leader节点收到RPC请求时，它将转发这个请求到集群leader。

Server节点还作为广域网`Gossip`池的部分运行。这个池和局域网的池是不同的，它**对因特网的高延迟专门做了优化**，并要求只包含Server节点。这个池的目的是让数据中心通过低接触的方式发现彼此。让一个新的数据中心上线比较简单，只需要加入已经存在的广域网`Gossip`。因为Server都在这个池中运行，它也支持跨数据中心的请求。当一个Server收到一个对不同数据中心的请求时，它转发这个请求到相应数据中心的一个随机Server，这个Server可能需要再次转发到本地leader。

这将在数据中心之间产生一个非常低的耦合，但是考虑到故障检测、连接缓存和复用，跨数据中心的请求是相对快速和可靠的。


# 更深入的了解

本文介绍了Consul的高层次架构，但是对于每个子系统仍有很多的细节。参考：一致性协议和`Gossip`协议已经详细记录，安全模型和协议的文档也是可用的。
- [一致性协议]()
- [Gossip 协议]()
- [安全模型]()